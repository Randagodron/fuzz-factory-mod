Version 4
SHEET 1 5552 1608
WIRE 4448 -80 4384 -80
WIRE 4544 -80 4544 -112
WIRE 4544 -80 4448 -80
WIRE 4448 -48 4448 -80
WIRE 4384 -32 4384 -80
WIRE 4544 -32 4544 -80
WIRE 4672 -32 4544 -32
WIRE 4544 0 4544 -32
WIRE 4672 16 4672 -32
WIRE 4272 64 4224 64
WIRE 4384 64 4384 32
WIRE 4384 64 4352 64
WIRE 4448 64 4448 32
WIRE 4448 64 4384 64
WIRE 4496 64 4448 64
WIRE 1200 112 1120 112
WIRE 1408 112 1280 112
WIRE 1536 112 1488 112
WIRE 1696 112 1600 112
WIRE 64 128 64 96
WIRE 352 128 352 96
WIRE 496 128 496 96
WIRE 640 128 640 96
WIRE 4544 144 4544 96
WIRE 4672 144 4672 96
WIRE 4672 144 4544 144
WIRE 4224 176 4224 64
WIRE 1200 224 1120 224
WIRE 1408 224 1280 224
WIRE 1696 224 1696 112
WIRE 1696 224 1488 224
WIRE 64 256 64 208
WIRE 352 256 352 208
WIRE 496 256 496 208
WIRE 640 256 640 208
WIRE 4224 304 4224 256
WIRE 1200 352 1120 352
WIRE 1408 352 1280 352
WIRE 1632 352 1488 352
WIRE 1696 352 1696 224
WIRE 1696 352 1632 352
WIRE 1696 416 1696 352
WIRE 64 512 64 480
WIRE 352 512 352 480
WIRE 496 512 496 480
WIRE 640 512 640 480
WIRE 1200 512 1120 512
WIRE 1408 512 1280 512
WIRE 1536 512 1488 512
WIRE 1632 512 1632 352
WIRE 1632 512 1600 512
WIRE 1696 544 1696 480
WIRE 5088 592 4800 592
WIRE 5088 624 5088 592
WIRE 64 640 64 592
WIRE 352 640 352 592
WIRE 496 640 496 592
WIRE 640 640 640 592
WIRE 4800 704 4800 592
WIRE 4800 704 4704 704
WIRE 1088 736 1040 736
WIRE 1248 736 1168 736
WIRE 5088 752 5088 704
WIRE 5120 752 5088 752
WIRE 5248 752 5184 752
WIRE 5376 752 5248 752
WIRE 4800 768 4800 704
WIRE 4544 800 4544 144
WIRE 4544 800 4080 800
WIRE 5088 800 5088 752
WIRE 5248 800 5248 752
WIRE -224 864 -224 800
WIRE 1088 864 1040 864
WIRE 1248 864 1168 864
WIRE 4800 912 4800 848
WIRE 5088 912 5088 880
WIRE 4544 928 4544 800
WIRE 5248 928 5248 880
WIRE -224 992 -224 944
WIRE 4336 992 3776 992
WIRE 3776 1040 3776 992
WIRE 4544 1056 4544 1008
WIRE 4544 1056 4448 1056
WIRE 4800 1056 4800 992
WIRE 4928 1056 4800 1056
WIRE 4448 1104 4448 1056
WIRE 4800 1104 4800 1056
WIRE 5088 1104 5088 992
WIRE 4544 1152 4544 1056
WIRE 4576 1152 4544 1152
WIRE 4672 1152 4640 1152
WIRE 4736 1152 4672 1152
WIRE 4928 1152 4928 1056
WIRE 5024 1152 4928 1152
WIRE 224 1168 224 1120
WIRE 864 1168 864 1120
WIRE 1552 1168 1552 1120
WIRE 2224 1168 2224 1120
WIRE 3776 1184 3776 1120
WIRE 4544 1184 4544 1152
WIRE 4224 1232 4192 1232
WIRE 4352 1232 4304 1232
WIRE 4448 1232 4448 1184
WIRE 4448 1232 4416 1232
WIRE 4480 1232 4448 1232
WIRE 224 1280 224 1248
WIRE 320 1280 224 1280
WIRE 864 1280 864 1248
WIRE 960 1280 864 1280
WIRE 1552 1280 1552 1248
WIRE 1632 1280 1552 1280
WIRE 2224 1280 2224 1248
WIRE 2304 1280 2224 1280
WIRE 4672 1280 4672 1152
WIRE 4864 1280 4672 1280
WIRE 5088 1280 5088 1200
WIRE 5088 1280 4944 1280
WIRE 5376 1280 5088 1280
WIRE 224 1312 224 1280
WIRE 864 1312 864 1280
WIRE 1552 1312 1552 1280
WIRE 2224 1312 2224 1280
WIRE 5088 1312 5088 1280
WIRE 3216 1328 3216 1280
WIRE 3776 1328 3776 1280
WIRE 16 1360 -32 1360
WIRE 128 1360 96 1360
WIRE 160 1360 128 1360
WIRE 656 1360 608 1360
WIRE 768 1360 736 1360
WIRE 800 1360 768 1360
WIRE 1344 1360 1280 1360
WIRE 1456 1360 1424 1360
WIRE 1488 1360 1456 1360
WIRE 2016 1360 1952 1360
WIRE 2128 1360 2096 1360
WIRE 2160 1360 2128 1360
WIRE 4544 1360 4544 1280
WIRE 4704 1360 4704 704
WIRE 4704 1360 4544 1360
WIRE 128 1408 128 1360
WIRE 768 1408 768 1360
WIRE 1456 1408 1456 1360
WIRE 2128 1408 2128 1360
WIRE 4544 1408 4544 1360
WIRE 4192 1424 4192 1232
WIRE 5376 1424 5376 1280
WIRE 5088 1440 5088 1392
WIRE 5088 1440 4992 1440
WIRE 3216 1472 3216 1408
WIRE 3776 1472 3776 1408
WIRE 5088 1488 5088 1440
WIRE 4992 1504 4992 1440
WIRE 128 1568 128 1488
WIRE 224 1568 224 1408
WIRE 768 1568 768 1488
WIRE 864 1568 864 1408
WIRE 1456 1568 1456 1488
WIRE 1552 1568 1552 1408
WIRE 2128 1568 2128 1488
WIRE 2224 1568 2224 1408
WIRE 4080 1600 4080 800
WIRE 4800 1600 4800 1200
WIRE 4800 1600 4080 1600
WIRE 4992 1600 4992 1568
WIRE 4992 1600 4800 1600
WIRE 5088 1600 5088 1568
WIRE 5088 1600 4992 1600
WIRE 5376 1600 5376 1504
WIRE 5376 1600 5088 1600
FLAG 64 256 0
FLAG 352 256 0
FLAG 496 256 0
FLAG 352 96 PWM1_1
FLAG 64 96 vPWM1
FLAG 496 96 PWM1_2
FLAG 64 640 0
FLAG 352 640 0
FLAG 496 640 0
FLAG 352 480 PWM2_1
FLAG 64 480 vPWM2
FLAG 496 480 PWM2_2
FLAG 1696 544 0
FLAG 1040 736 0
FLAG 1040 864 0
FLAG 640 256 0
FLAG 640 96 PWM1_3
FLAG 640 640 0
FLAG 640 480 PWM2_3
FLAG -224 992 0
FLAG -224 800 vcc
FLAG 224 1568 0
FLAG 224 1120 vcc
FLAG 128 1568 0
FLAG 864 1568 0
FLAG 864 1120 vcc
FLAG 768 1568 0
FLAG 1552 1568 0
FLAG 1552 1120 vcc
FLAG 1456 1568 0
FLAG 2224 1568 0
FLAG 2224 1120 vcc
FLAG 2128 1568 0
FLAG -32 1360 vPWM1
FLAG 608 1360 vPWM2
FLAG 1248 736 vPWM1n
FLAG 1248 864 vPWM2n
FLAG 1280 1360 vPWM1n
FLAG 1952 1360 vPWM2n
FLAG 320 1280 vPWM1_buff
FLAG 960 1280 vPWM2_buff
FLAG 1632 1280 vPWM1n_buff
FLAG 2304 1280 vPWM2n_buff
FLAG 1120 112 0
FLAG 1120 224 0
FLAG 1120 352 0
FLAG 1120 512 0
FLAG 5376 752 out
FLAG 3776 1184 0
FLAG 3776 1472 0
FLAG 3776 1280 venv
FLAG 5248 928 0
FLAG 4192 1424 0
FLAG 4544 1408 0
FLAG 4224 304 0
FLAG 4544 -112 vcc
FLAG 3216 1472 0
FLAG 3216 1280 vsin
FLAG 1696 112 vDrive
SYMBOL bv 64 112 R0
WINDOW 3 -440 101 Left 2
SYMATTR Value V=V(PWM1_1)+V(PWM1_2)+V(PWM1_3)
SYMATTR InstName B1
SYMBOL voltage 352 112 R0
WINDOW 3 -110 195 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 0 0 0 1u 12.75u 1568)
SYMATTR InstName V1
SYMBOL voltage 496 112 R0
WINDOW 3 -75 175 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 20m 0 0 6u 12.75u 314)
SYMATTR InstName V2
SYMBOL bv 64 496 R0
WINDOW 3 -461 117 Left 2
SYMATTR Value V=V(PWM2_1)+V(PWM2_2)+V(PWM2_3)
SYMATTR InstName B2
SYMBOL voltage 352 496 R0
WINDOW 3 -110 195 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 0 0 0 4u 12.75u 3137)
SYMATTR InstName V3
SYMBOL voltage 496 496 R0
WINDOW 3 -100 231 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 40m 0 0 8u 12.75u 1568)
SYMATTR InstName V4
SYMBOL res 1504 208 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value 1Meg
SYMBOL res 1504 336 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 3k9
SYMBOL cap 1680 416 R0
SYMATTR InstName C1
SYMATTR Value 100n
SYMBOL bv 1184 736 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B3
SYMATTR Value V=inv(V(vPWM1))*3.3
SYMBOL res 1504 96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R3
SYMATTR Value 1Meg
SYMBOL cap 1600 96 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value 100n
SYMBOL bv 1184 864 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B4
SYMATTR Value V=inv(V(vPWM2))*3.3
SYMBOL res 1504 496 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 3k9
SYMBOL cap 1600 496 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C3
SYMATTR Value 100n
SYMBOL voltage 640 112 R0
WINDOW 3 -81 198 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 24m 0 0 12u 12.75u 314)
SYMATTR InstName V5
SYMBOL voltage 640 496 R0
WINDOW 3 -66 192 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 3.3 60m 0 0 8.05u 12.75u)
SYMATTR InstName V6
SYMBOL npn 160 1312 R0
SYMATTR InstName Q1
SYMATTR Value 2N5089
SYMBOL res 208 1152 R0
SYMATTR InstName R5
SYMATTR Value 4k7
SYMBOL res 112 1344 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 2k2
SYMBOL voltage -224 848 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V7
SYMATTR Value 9v
SYMBOL res 112 1392 R0
SYMATTR InstName R7
SYMATTR Value 10k
SYMBOL npn 800 1312 R0
SYMATTR InstName Q2
SYMATTR Value 2N5089
SYMBOL res 848 1152 R0
SYMATTR InstName R8
SYMATTR Value 4k7
SYMBOL res 752 1344 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R9
SYMATTR Value 2k2
SYMBOL res 752 1392 R0
SYMATTR InstName R10
SYMATTR Value 10k
SYMBOL npn 1488 1312 R0
SYMATTR InstName Q3
SYMATTR Value 2N5089
SYMBOL res 1536 1152 R0
SYMATTR InstName R11
SYMATTR Value 4k7
SYMBOL res 1440 1344 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R12
SYMATTR Value 2k2
SYMBOL res 1440 1392 R0
SYMATTR InstName R13
SYMATTR Value 10k
SYMBOL npn 2160 1312 R0
SYMATTR InstName Q4
SYMATTR Value 2N5089
SYMBOL res 2208 1152 R0
SYMATTR InstName R14
SYMATTR Value 4k7
SYMBOL res 2112 1344 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R15
SYMATTR Value 2k2
SYMBOL res 2112 1392 R0
SYMATTR InstName R16
SYMATTR Value 10k
SYMBOL bv 1296 224 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B5
SYMATTR Value V=V(vPWM1_buff)
SYMBOL bv 1296 112 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B6
SYMATTR Value V=V(vPWM1n_buff)
SYMBOL bv 1296 352 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B7
SYMATTR Value V=V(vPWM2_buff)
SYMBOL bv 1296 512 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName B8
SYMATTR Value V=V(vPWM2n_buff)
SYMBOL voltage 3776 1312 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V8
SYMATTR Value PWL(0 0.001 100m 1)
SYMBOL bv 3776 1024 R0
SYMATTR InstName B9
SYMATTR Value V=V(vsin)*V(venv)
SYMBOL pnp 4736 1104 R0
SYMATTR InstName Q5
SYMATTR Value 2N2907
SYMBOL pnp 5024 1104 R0
SYMATTR InstName Q6
SYMATTR Value 2N2907
SYMBOL cap 4416 1216 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C4
SYMATTR Value 100n
SYMBOL res 4784 896 R0
SYMATTR InstName R17
SYMATTR Value 470
SYMBOL res 5072 896 R0
SYMATTR InstName R18
SYMATTR Value 5.1k
SYMBOL res 4960 1264 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R19
SYMATTR Value 47k
SYMBOL res 5072 1296 R0
SYMATTR InstName R20
SYMATTR Value R=20k*(1-GAIN)
SYMBOL res 5072 1472 R0
SYMATTR InstName R21
SYMATTR Value R=20k*GAIN
SYMBOL cap 4976 1504 R0
SYMATTR InstName C5
SYMATTR Value 10µ
SYMBOL res 5104 896 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R22
SYMATTR Value R=5k*(1-VOLUME)
SYMBOL res 5104 720 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R23
SYMATTR Value R=5k*VOLUME
SYMBOL npn 4480 1184 R0
SYMATTR InstName Q7
SYMATTR Value 2N3904
SYMBOL res 4432 1088 R0
SYMATTR InstName R24
SYMATTR Value 220k
SYMBOL cap 4640 1136 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C6
SYMATTR Value 100n
SYMBOL cap 5184 736 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C7
SYMATTR Value 10µ
SYMBOL res 5232 784 R0
SYMATTR InstName R25
SYMATTR Value 220k
SYMBOL res 4784 752 R0
SYMATTR InstName R26
SYMATTR Value R=10k*GATE
SYMBOL res 4528 912 R0
SYMATTR InstName R27
SYMATTR Value 10k
SYMBOL res 5360 1408 R0
SYMATTR InstName R28
SYMATTR Value R=10k*COMP
SYMBOL res 4320 1216 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R29
SYMATTR Value 200k
SYMBOL bv 4224 160 R0
SYMATTR InstName B10
SYMATTR Value V=V(vDrive)
SYMBOL njf 4496 0 R0
SYMATTR InstName J1
SYMATTR Value 2N5484
SYMBOL res 4432 -64 R0
SYMATTR InstName R30
SYMATTR Value 51k
SYMBOL cap 4368 -32 R0
SYMATTR InstName C8
SYMATTR Value 10n
SYMBOL res 4368 48 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R31
SYMATTR Value 1k
SYMBOL res 4656 0 R0
SYMATTR InstName R32
SYMATTR Value 5k
SYMBOL voltage 3216 1312 R0
WINDOW 123 24 124 Left 2
WINDOW 39 0 0 Left 2
SYMATTR Value2 AC 1
SYMATTR InstName V10
SYMATTR Value SINE(0 100m 1k)
TEXT -304 376 Left 2 !.tran 100m
TEXT 1848 624 Left 2 ;https://www.edn.com/design/analog/4459116/Cancel-PWM-DAC-ripple-with-analog-subtraction
TEXT 1848 656 Left 2 ;http://www.openmusiclabs.com/learning/digital/pwm-dac/dual-pwm-circuits/index.html
TEXT 1856 112 Left 2 ;8b resolution\n20MHz peripheral clock\n  -> Tclk (step) = 50ns -> Tsig = 12.75µs / Fsig = 78kHz\n16b @ 9V -> resol 137µV\n  LSB : 137uV\n  MSB : 35mV
TEXT 3744 672 Left 2 !.param GAIN=0.8
TEXT 3744 696 Left 2 !.param VOLUME=0.5
TEXT 3744 720 Left 2 !.param STAB=0.01
TEXT 3744 744 Left 2 !.param GATE=0.6
TEXT 3744 768 Left 2 !.param COMP=0.4
